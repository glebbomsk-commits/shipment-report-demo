<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MKS Kusto Logistics — Прототип отчёта об отгрузке</title>
  <meta name="description" content="Прототип портала: редактируемая таблица отчёта об отгрузке со всеми колонками из Excel."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { primary: '#0B3B60', accent: '#0FA4E5', ink: '#0E2433', soft: '#EFF6FB' }
          },
          boxShadow: { smooth: '0 6px 18px rgba(11,59,96,0.08)' }
        }
      }
    }
  </script>
  <style>
    .brand-gradient{background:linear-gradient(90deg,#0B3B60 0%,#0FA4E5 100%)}
    .sticky-th th{position:sticky;top:0;background:#f8fafc;z-index:2}
    .sticky-left{position:sticky;left:0;z-index:3;background:#ffffff}
    .cell-input{width:100%; min-width:180px;}
    .cell-input.sm{min-width:140px;}
  </style>
</head>
<body class="bg-brand-soft text-brand-ink">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    const STORAGE_KEY = "mks_excel_prototype_v1";

    function clsx(...xs){ return xs.filter(Boolean).join(' '); }

    async function fetchJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok) throw new Error("Fetch failed: " + url);
      return await r.json();
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function toCSV(schema, rows){
      const cols = schema.map(c=>c.key);
      const esc = (v)=> '"'+String(v??"").replaceAll('"','""')+'"';
      const header = cols.map(esc).join(",");
      const lines = rows.map(r => cols.map(k=>esc(r[k] ?? "")).join(","));
      return [header, ...lines].join("\n");
    }

    function CellEditor({ col, value, onChange }) {
      const v = value ?? "";
      if(col.type === "select"){
        return (
          <select className="cell-input h-10 rounded-md border border-slate-200 bg-white px-2" value={v} onChange={e=>onChange(e.target.value)}>
            <option value="">—</option>
            {col.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
          </select>
        );
      }
      if(col.type === "date"){
        return <input type="date" className="cell-input sm h-10 rounded-md border border-slate-200 px-2" value={v} onChange={e=>onChange(e.target.value)} />;
      }
      if(col.type === "time"){
        return <input type="time" className="cell-input sm h-10 rounded-md border border-slate-200 px-2" value={v} onChange={e=>onChange(e.target.value)} />;
      }
      if(col.type === "number"){
        return <input type="number" className="cell-input sm h-10 rounded-md border border-slate-200 px-2" value={v} onChange={e=>onChange(e.target.value)} />;
      }
      return <input className="cell-input h-10 rounded-md border border-slate-200 px-2" value={v} onChange={e=>onChange(e.target.value)} />;
    }

    function App(){
      const [schema, setSchema] = useState(null);
      const [rows, setRows] = useState([]);
      const [query, setQuery] = useState("");
      const [onlyChanged, setOnlyChanged] = useState(false);

      useEffect(()=>{
        (async()=>{
          const [s, d] = await Promise.all([fetchJSON("./schema.json"), fetchJSON("./data.json")]);

          const saved = localStorage.getItem(STORAGE_KEY);
          if(saved){
            try{
              const parsed = JSON.parse(saved);
              if(parsed?.schema && parsed?.rows){
                setSchema(parsed.schema);
                setRows(parsed.rows);
                return;
              }
            } catch {}
          }

          setSchema(s);
          const withMeta = d.map((r,i)=>({ _id: i+1, _dirty:false, ...r }));
          setRows(withMeta);
        })().catch(err=>{
          console.error(err);
          alert("Не удалось загрузить schema.json / data.json. Проверь, что файлы лежат в корне репозитория.");
        });
      }, []);

      useEffect(()=>{
        if(!schema) return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ schema, rows }));
      }, [schema, rows]);

      const filtered = useMemo(()=>{
        if(!schema) return [];
        let r = rows;
        if(onlyChanged) r = r.filter(x=>x._dirty);
        if(!query.trim()) return r;
        const q = query.toLowerCase();
        return r.filter(row => {
          const keys = schema.slice(0, 10).map(c=>c.key);
          for (const k of keys) {
            const v = (row[k] ?? "").toString().toLowerCase();
            if(v.includes(q)) return true;
          }
          return false;
        });
      }, [schema, rows, query, onlyChanged]);

      const stats = useMemo(()=>{
        if(!schema) return null;
        const total = rows.length;
        const changed = rows.filter(r=>r._dirty).length;
        const statusCol = schema.find(c => /статус/i.test(c.key));
        let statusCount = null;
        if(statusCol){
          const m = new Map();
          for(const r of rows){
            const v = (r[statusCol.key] ?? "").toString().trim() || "—";
            m.set(v, (m.get(v)||0)+1);
          }
          statusCount = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
        }
        return { total, changed, statusCol: statusCol?.key ?? null, statusCount };
      }, [schema, rows]);

      function addRow(){
        if(!schema) return;
        const blank = { _id: (rows.at(0)? rows[0]._id+1 : rows.length+1), _dirty:true };
        for(const c of schema) blank[c.key] = "";
        setRows([blank, ...rows]);
      }

      function updateCell(rowId, key, value){
        setRows(prev => prev.map(r => r._id===rowId ? { ...r, [key]: value, _dirty:true } : r));
      }

      function exportJSON(){
        downloadText("mks-rows.json", JSON.stringify(rows, null, 2));
      }

      function exportCSV(){
        const csv = toCSV(schema, rows);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "mks-rows.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      function resetLocal(){
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }

      if(!schema){
        return (
          <div className="min-h-screen flex items-center justify-center text-slate-600">
            Загрузка схемы и данных…
          </div>
        );
      }

      return (
        <div>
          <header className="brand-gradient text-white">
            <div className="max-w-7xl mx-auto px-4 py-6 flex items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-full bg-white/15 ring-1 ring-white/20 flex items-center justify-center font-bold">MKS</div>
                <div>
                  <div className="text-sm opacity-90">MKS Kusto Logistics</div>
                  <div className="text-xl font-semibold leading-tight">Прототип: Отчет об отгрузке</div>
                </div>
              </div>
              <span className="text-xs border border-white/30 px-2 py-1 rounded-full">Демо</span>
            </div>
          </header>

          <main className="max-w-[1500px] mx-auto px-4 py-6 space-y-4">
            <section className="grid lg:grid-cols-12 gap-4">
              <div className="lg:col-span-8 rounded-2xl bg-white border border-slate-200 shadow-smooth p-4">
                <div className="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <div className="font-semibold text-slate-800">Таблица (все колонки из Excel)</div>
                    <div className="text-sm text-slate-500">Каждая ячейка редактируется. Для колонок с небольшим числом значений — выпадающий список.</div>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <button onClick={addRow} className="px-3 py-2 rounded-xl bg-brand-primary text-white text-sm shadow-smooth hover:opacity-95">+ Добавить строку</button>
                    <button onClick={exportCSV} className="px-3 py-2 rounded-xl bg-white border border-slate-200 text-slate-700 text-sm hover:bg-slate-50">⬇ CSV</button>
                    <button onClick={exportJSON} className="px-3 py-2 rounded-xl bg-white border border-slate-200 text-slate-700 text-sm hover:bg-slate-50">⬇ JSON</button>
                    <button onClick={resetLocal} className="px-3 py-2 rounded-xl bg-white border border-slate-200 text-rose-700 text-sm hover:bg-slate-50">Сбросить правки</button>
                  </div>
                </div>

                <div className="mt-4 grid md:grid-cols-12 gap-3">
                  <div className="md:col-span-6">
                    <div className="text-xs text-slate-500 mb-1">Поиск (по первым колонкам)</div>
                    <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Напр.: госномер, статус, номер ТЕ…" className="w-full h-10 rounded-md border border-slate-200 px-3"/>
                  </div>
                  <div className="md:col-span-3 flex items-end">
                    <label className="flex items-center gap-2 text-sm text-slate-700">
                      <input type="checkbox" checked={onlyChanged} onChange={e=>setOnlyChanged(e.target.checked)} />
                      Только измененные
                    </label>
                  </div>
                  <div className="md:col-span-3 rounded-xl bg-brand-soft border border-slate-200 p-3">
                    <div className="text-xs text-slate-500">Строк</div>
                    <div className="text-lg font-semibold">{stats.total} <span className="text-slate-400 text-sm">всего</span> · {stats.changed} <span className="text-slate-400 text-sm">изменено</span></div>
                  </div>
                </div>
              </div>

              <div className="lg:col-span-4 space-y-4">
                <div className="rounded-2xl bg-white border border-slate-200 shadow-smooth p-4">
                  <div className="font-semibold text-slate-800">Статусы (демо)</div>
                  {stats.statusCount ? (
                    <div className="mt-3 space-y-2">
                      {stats.statusCount.map(([k,v]) => (
                        <div key={k} className="flex items-center justify-between text-sm">
                          <span className="text-slate-700 truncate">{k}</span>
                          <span className="text-slate-500">{v}</span>
                        </div>
                      ))}
                      <div className="mt-2 text-xs text-slate-500">Колонка статуса: <span className="font-mono">{stats.statusCol}</span></div>
                    </div>
                  ) : (
                    <div className="mt-2 text-sm text-slate-500">Не удалось найти колонку со словом «Статус».</div>
                  )}
                </div>

                <div className="rounded-2xl bg-white border border-slate-200 shadow-smooth p-4">
                  <div className="font-semibold text-slate-800">Подключение к реальным данным (следующий шаг)</div>
                  <ul className="mt-2 text-sm text-slate-600 list-disc pl-5 space-y-1">
                    <li>Сейчас данные читаются из <span className="font-mono">data.json</span> и <span className="font-mono">schema.json</span>.</li>
                    <li>Дальше подключаем API (WMS/TMS/ERP) или Supabase/Sheets.</li>
                    <li>Правки сохраняются в браузере (localStorage) как черновик.</li>
                  </ul>
                </div>
              </div>
            </section>

            <section className="rounded-2xl bg-white border border-slate-200 shadow-smooth overflow-hidden">
              <div className="p-4 border-b flex items-center justify-between">
                <div className="font-semibold text-slate-800">Редактируемая таблица</div>
                <div className="text-sm text-slate-500">Показано: {filtered.length}</div>
              </div>

              <div className="overflow-auto max-h-[70vh]">
                <table className="text-sm">
                  <thead className="sticky-th text-left text-slate-600 border-b">
                    <tr>
                      <th className="px-3 py-2 sticky-left min-w-[220px]">#</th>
                      {schema.map((c) => (
                        <th key={c.key} className="px-3 py-2 min-w-[220px] whitespace-nowrap">{c.label}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map((r) => (
                      <tr key={r._id} className={clsx("border-b hover:bg-slate-50", r._dirty ? "bg-amber-50/40" : "bg-white")}>
                        <td className="px-3 py-2 sticky-left min-w-[220px]">
                          <div className="flex items-center justify-between gap-2">
                            <span className="font-medium">Row {r._id}</span>
                            {r._dirty && <span className="text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-700">изменено</span>}
                          </div>
                        </td>

                        {schema.map((c) => (
                          <td key={c.key} className="px-3 py-2 align-top">
                            <CellEditor col={c} value={r[c.key]} onChange={(v)=>updateCell(r._id, c.key, v)} />
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
